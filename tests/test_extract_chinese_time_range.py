import datetime
import unittest

from agile_commons.utils.extract_chinese_time_range import extract_chinese_time_range


class TestExtractChineseTimeRange(unittest.TestCase):

    def setUp(self):
        self.curr = datetime.datetime(2026, 2, 12, 11, 30)

    def _assert_cases(self, cases):
        for text, expected in cases:
            with self.subTest(text=text):
                self.assertEqual(expected, extract_chinese_time_range(text, self.curr))

    def test_relative_dates(self):
        cases = [
            ("昨天我和你说了什么？", ['2026-02-11 00:00:00', '2026-02-11 23:59:59']),
            ("上周末我们去打篮球了。", ['2026-02-07 00:00:00', '2026-02-08 23:59:59']),
            ("还记得上个月我们一起逛街么？", ['2026-01-01 00:00:00', '2026-01-31 23:59:59']),
            ("去年我们去了北京旅游。", ['2025-01-01 00:00:00', '2025-12-31 23:59:59']),
            ("下一年要多存点钱。", ['2027-01-01 00:00:00', '2027-12-31 23:59:59']),
            ("来年加倍努力工作。", ['2027-01-01 00:00:00', '2027-12-31 23:59:59']),
            ("本年度的工作计划是什么？", ['2026-01-01 00:00:00', '2026-12-31 23:59:59']),
            ("下季度计划拓展新业务。", ['2026-04-01 00:00:00', '2026-06-30 23:59:59']),
            ("2026年第三季度要去上海出差。", ['2026-07-01 00:00:00', '2026-09-30 23:59:59']),
            ("五个月前入职的", ['2025-09-01 00:00:00', '2025-09-30 23:59:59']),
        ]
        self._assert_cases(cases)

    def test_week_expressions(self):
        cases = [
            ("下周五记得提醒我去出差。", ['2026-02-20 00:00:00', '2026-02-20 23:59:59']),
            ("本周五公司团建。", ['2026-02-13 00:00:00', '2026-02-13 23:59:59']),
            ("下个星期三到星期六，我们去旅游。", ['2026-02-18 00:00:00', '2026-02-21 23:59:59']),
            ("这个礼拜有空，可以一起钓鱼。", ['2026-02-09 00:00:00', '2026-02-15 23:59:59']),
            ("礼拜四有空，来找我。", ['2026-02-12 00:00:00', '2026-02-12 23:59:59']),
            ("上个礼拜天是周几？", ['2026-02-08 00:00:00', '2026-02-08 23:59:59']),
            ("下个星期二开会。", ['2026-02-17 00:00:00', '2026-02-17 23:59:59']),
            ("上上周五我们去爬山了", ['2026-01-30 00:00:00', '2026-01-30 23:59:59']),
            ("下下周我都要上班", ['2026-02-23 00:00:00', '2026-03-01 23:59:59']),
            ("两周的数据汇总", ['2026-02-02 00:00:00', '2026-02-15 23:59:59']),
        ]
        self._assert_cases(cases)

    def test_day_offsets(self):
        cases = [
            ("3天前我们开了个会", ['2026-02-09 00:00:00', '2026-02-09 23:59:59']),
            ("3天后完成任务", ['2026-02-15 00:00:00', '2026-02-15 23:59:59']),
        ]
        self._assert_cases(cases)

    def test_time_points_and_periods(self):
        cases = [
            ("今天晚上8点半记得提醒我写日报。", ['2026-02-12 20:30:00']),
            ("明天上午7点20有文艺演出。", ['2026-02-13 07:20:00']),
            ("明天下午一起吃饭。", ['2026-02-13 14:00', '2026-02-13 17:59:59']),
            ("晚上9点到12点上班", ['2026-02-12 21:00:00', '2026-02-13 00:00:00']),
        ]
        self._assert_cases(cases)

    def test_hour_minute_offsets(self):
        cases = [
            ("1小时前", ['2026-02-12 10:30:00']),
            ("昨天1小时前", ['2026-02-11 10:30:00']),
        ]
        self._assert_cases(cases)


if __name__ == "__main__":
    unittest.main()
